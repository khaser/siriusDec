<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="static/css/bootstrap.min.css"
          integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

    <title>Сириус</title>

    <style>
        body {
            padding-top: 5rem;
        }
    </style>
</head>
<body>
<main role="main" class="container">
    <div class="starter">
        <h1>Hello world</h1>
    </div>
    <!--
    TODO(3): Напишите реализацию счетчика!
    -->
    <div id="the-counter">
        <p id="counter-value" class="lead"></p>
        <button id="counter-button-inc" type="button" class="btn btn-primary">INCREMENT</button>
        <button id="counter-button-dec" type="button" class="btn btn-primary">DECREMENT</button>
    </div>
    <div id="the-tester">
        <div class="btn-group">
            <button id="tester-inc-start-button" type="button" class="btn btn-secondary">Start increment stress test</button>
            <button id="tester-dec-start-button" type="button" class="btn btn-secondary">Start decrement stress test</button>
            <button id="tester-stop-button" type="button" class="btn btn-secondary">Стоп</button>
        </div>
    </div>
    <div id="the-log">
    </div>
</main>

<script src="static/js/jquery-3.4.1.slim.min.js"
        integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
        crossorigin="anonymous"></script>
<script src="static/js//popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
<script src="static/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>

<script>
    // TODO(1) ACCEPTED: Упражнение на JavaScript.
    // Напишите функцию, которая будет генерировать простое, читаемое,
    // но уникальное имя пользователя. Для этого заведите массив названий животных,
    // и при генерации имени выбирайте случайное животное и дописывайте случайное число
    // от 1000 до 10000.
    var animals = ["Aardvark",
        "Abyssinian",
        "Adelie Penguin",
        "Affenpinscher",
        "Afghan Hound",
        "African Bush Elephant",
        "African Civet",
        "African Clawed Frog",
        "African Forest Elephant",
        "African Palm Civet",
        "African Penguin",
        "African Tree Toad",
        "African Wild Dog",
        "Ainu Dog",
        "Airedale Terrier",
        "Akbash",
        "Akita",
        "Alaskan Malamute",
        "Albatross",
        "Aldabra Giant Tortoise",
        "Alligator",
        "Alpine Dachsbracke",
        "American Bulldog",
        "American Cocker Spaniel",
        "American Coonhound",
        "American Eskimo Dog",
        "American Foxhound",
        "American Pit Bull Terrier",
        "American Staffordshire Terrier",
        "American Water Spaniel",
        "Anatolian Shepherd Dog",
        "Angelfish",
        "Ant",
        "Anteater",
        "Antelope",
        "Appenzeller Dog",
        "Arctic Fox",
        "Arctic Hare",
        "Arctic Wolf",
        "Armadillo",
        "Asian Elephant",
        "Asian Giant Hornet",
        "Asian Palm Civet",
        "Asiatic Black Bear",
        "Australian Cattle Dog",
        "Australian Kelpie Dog",
        "Australian Mist",
        "Australian Shepherd",
        "Australian Terrier",
        "Avocet",
        "Axolotl",
        "Aye Aye",
        "Baboon",
        "Bactrian Camel",
        "Badger",
        "Balinese",
        "Banded Palm Civet",
        "Bandicoot",
        "Barb",
        "Barn Owl",
        "Barnacle",
        "Barracuda",
        "Basenji Dog",
        "Basking Shark",
        "Basset Hound",
        "Bat",
        "Bavarian Mountain Hound",
        "Beagle",
        "Bear",
        "Bearded Collie",
        "Bearded Dragon",
        "Beaver",
        "Bedlington Terrier",
        "Beetle",
        "Bengal Tiger",
        "Bernese Mountain Dog",
        "Bichon Frise",
        "Binturong",
        "Bird",
        "Birds Of Paradise",
        "Birman",
        "Bison",
        "Black Bear",
        "Black Rhinoceros",
        "Black Russian Terrier",
        "Black Widow Spider",
        "Bloodhound",
        "Blue Lacy Dog",
        "Blue Whale",
        "Bluetick Coonhound",
        "Bobcat",
        "Bolognese Dog",
        "Bombay",
        "Bongo",
        "Bonobo",
        "Booby",
        "Border Collie",
        "Border Terrier",
        "Bornean Orang-utan",
        "Borneo Elephant",
        "Boston Terrier",
        "Bottle Nosed Dolphin",
        "Boxer Dog",
        "Boykin Spaniel",
        "Brazilian Terrier",
        "Brown Bear",
        "Budgerigar",
        "Buffalo",
        "Bull Mastiff",
        "Bull Shark",
        "Bull Terrier",
        "Bulldog",
        "Bullfrog",
        "Bumble Bee",
        "Burmese",
        "Burrowing Frog",
        "Butterfly",
        "Butterfly Fish",
        "Caiman",
        "Caiman Lizard",
        "Cairn Terrier",
        "Camel",
        "Canaan Dog",
        "Capybara",
        "Caracal",
        "Carolina Dog",
        "Cassowary",
        "Cat",
        "Caterpillar",
        "Catfish",
        "Cavalier King Charles Spaniel",
        "Centipede",
        "Cesky Fousek",
        "Chameleon",
        "Chamois",
        "Cheetah",
        "Chesapeake Bay Retriever",
        "Chicken",
        "Chihuahua",
        "Chimpanzee",
        "Chinchilla",
        "Chinese Crested Dog",
        "Chinook",
        "Chinstrap Penguin",
        "Chipmunk",
        "Chow Chow",
        "Cichlid",
        "Clouded Leopard",
        "Clown Fish",
        "Clumber Spaniel",
        "Coati",
        "Cockroach",
        "Collared Peccary",
        "Collie",
        "Common Buzzard",
        "Common Frog",
        "Common Loon",
        "Common Toad",
        "Coral",
        "Cottontop Tamarin",
        "Cougar",
        "Cow",
        "Coyote",
        "Crab",
        "Crab-Eating Macaque",
        "Crane",
        "Crested Penguin",
        "Crocodile",
        "Cross River Gorilla",
        "Curly Coated Retriever",
        "Cuscus",
        "Cuttlefish",
    ];

    var rand_int = Math.floor(Math.random() * animals.length);
    console.log(rand_int);
    var user = animals[rand_int] + " " + Math.floor(Math.random() * 9000 + 1000);

    var inc_clicks = new Set();
    var dec_clicks = new Set();
    var inc_cnt = 0;
    var dec_cnt = 0;


    // Устанавливаем подключение к серверу.
    var ws = new WebSocket("ws://" + document.domain + ":" + location.port + "/ws4");
    messages = document.createElement("ul");
    document.getElementsByClassName("starter")[0].appendChild(messages);

    // Функция-обработчик при получении нового сообщения.
    function send(type, s, element) {
        a = [];
        a.push(type);
        if (element != "flag")
            a.push(element);
        s.forEach(
            function (x) {
            a.push(x);
        });
        ws.send(JSON.stringify(a));
    }

    ws.onmessage = function (event) {
        if (event.data == "HELP ME") {
            send("inc", inc_clicks, "flag");
            send("dec", dec_clicks, "flag");
            return;
        }

        var data = JSON.parse(event.data);
        console.log(data);
        switch (data[0]) {
            case "inc" : {
                for (let i = 1; i < data.length; ++i) {
                    inc_clicks.add(data[i]);
                }
                break;
            }
            case "dec" : {
                for (let i = 1; i < data.length; ++i) {
                    dec_clicks.add(data[i]);
                }
            }
        }
        console.log(inc_clicks.size, dec_clicks.size);
        $("#counter-value").text(inc_clicks.size - dec_clicks.size);
    };

    ws.onopen = function () {
        console.log("Установили соединение с сервером.");
        ws.send("HELP ME");
    };

    //TODO(3): Напишите реализацию счетчика!
    //Здесь #counter-button -- это ссылка на кнопку с id="counter-button".
    //Также #counter-value -- это ссылка на элемент верстки с id="counter-value".
    //Конструкция $(...).text("...") изменяет текстовое содержимое элемента верстки.
    //TODO(4). Код для тестирования.
    //setTimeout(f, dt) планирует исполнение функции f через dt миллисекунд.
    //$("#some-id").click() генерирует нажатие на элемент с id="some-id".
    //По сути, код через случайные промежутки времени нажимает на кнопку 100 раз.

    var step = 500, speed = 10;
    var testStateinc = {counter: 0, iterations: step};
    var testStatedec = {counter: 0, iterations: step};

    var testLoopinc = function () {
        if (testStateinc.counter < testStateinc.iterations) {
            console.log("Нажимаем на кнопку " + testStateinc.counter + "-й раз!");
            $("#counter-button-inc").click();
            testStateinc.counter++;
            setTimeout(testLoopinc, Math.random() * speed);
        } else {
            console.log("Тестирование закончено!")
        }
    };

    var testLoopdec = function () {
        if (testStatedec.counter < testStatedec.iterations) {
            console.log("Нажимаем на кнопку " + testStatedec.counter + "-й раз!");
            $("#counter-button-dec").click();
            testStatedec.counter++;
            setTimeout(testLoopdec, Math.random() * speed);
        } else {
            console.log("Тестирование закончено!")
        }
    };

    $("#tester-inc-start-button").click(function () {
        testStateinc.counter = 0;
        testStateinc.iterations = step;
        testLoopinc();
    });

    $("#tester-dec-start-button").click(function () {
        testStatedec.counter = 0;
        testStatedec.iterations = step;
        testLoopdec();
    });

    $("#tester-stop-button").click(function () {
        testStateinc.counter = 0;
        testStateinc.iterations = 0;
        testStatedec.counter = 0;
        testStatedec.iterations = 0;
    });


    $("#counter-button-inc").click(function (event) {
            console.log("inc");
            event.preventDefault();
            send("inc", inc_clicks, user + ',' + inc_cnt);
            inc_cnt += 1;
        }
    );

    $("#counter-button-dec").click(
        function (event) {
            console.log("dec");
            event.preventDefault();
            send("dec", dec_clicks, user + ',' + dec_cnt);
            dec_cnt += 1;
        }
    );

</script>
</body>
</html>
